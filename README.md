# é£ä¹¦ Claude CLI æµå¼å¯¹è¯æœºå™¨äºº

åŸºäºé£ä¹¦å¹³å°å’Œ Claude CLI çš„æ™ºèƒ½å¯¹è¯æœºå™¨äººï¼Œæ”¯æŒæµå¼è¾“å‡ºå’Œæ‰“å­—æœºæ•ˆæœã€‚

## é¡¹ç›®æ¦‚è¿°

é€šè¿‡é›†æˆ Claude CLI å’Œé£ä¹¦ CardKit 2.0ï¼Œå®ç°å®æ—¶æµå¼å¯¹è¯çš„é£ä¹¦æœºå™¨äººï¼š

- ğŸ¤– **Claude CLI é›†æˆ**ï¼šä½¿ç”¨æœ¬åœ° Claude CLI è¿›è¡Œå¯¹è¯
- âš¡ **æµå¼è¾“å‡º**ï¼šå®æ—¶æ˜¾ç¤º AI å›å¤ï¼Œæ‰“å­—æœºæ•ˆæœ
- ğŸ’¬ **CardKit 2.0**ï¼šä½¿ç”¨é£ä¹¦å¡ç‰‡å±•ç¤ºå¯¹è¯å†…å®¹
- ğŸ”Œ **WebSocket é•¿è¿æ¥**ï¼šå®æ—¶æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯
- ğŸ“ **Markdown æ”¯æŒ**ï¼šæ”¯æŒæ ¼å¼åŒ–æ–‡æœ¬å’Œä»£ç é«˜äº®

## æŠ€æœ¯æ ˆ

- **è¯­è¨€**ï¼šGo 1.22.6
- **é£ä¹¦ SDK**ï¼š`github.com/larksuite/oapi-sdk-go/v3`
- **Claude CLI**ï¼šæœ¬åœ°è¿›ç¨‹è°ƒç”¨ï¼ˆä½¿ç”¨ `cc1` å‘½ä»¤ï¼‰
- **é€šä¿¡æ–¹å¼**ï¼šWebSocket é•¿è¿æ¥
- **å¡ç‰‡å±•ç¤º**ï¼šCardKit v1 + JSON 2.0 Schema

## é¡¹ç›®ç»“æ„

```
./
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ bot/                      # ä¸»ç¨‹åºå…¥å£
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ bot/
â”‚   â”‚   â”œâ”€â”€ client/               # é£ä¹¦å®¢æˆ·ç«¯å°è£…
â”‚   â”‚   â”‚   â””â”€â”€ feishu.go
â”‚   â”‚   â””â”€â”€ handlers/             # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â”‚       â””â”€â”€ message.go
â”‚   â”œâ”€â”€ claude/                   # Claude CLI é›†æˆ
â”‚   â”‚   â”œâ”€â”€ manager.go            # CLI è¿›ç¨‹ç®¡ç†
â”‚   â”‚   â””â”€â”€ streaming_text_handler.go  # æµå¼æ–‡æœ¬å¤„ç†
â”‚   â”œâ”€â”€ config/                   # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ chat_config.go        # èŠå¤©é…ç½®ï¼ˆé¡¹ç›®ç»‘å®šï¼‰
â”‚   â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ paths.go
â”‚       â””â”€â”€ timeout.go
â”œâ”€â”€ configs/                      # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ chat_config.json          # èŠå¤©é…ç½®ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ scripts/                      # éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ start-bot.sh
â”‚   â”œâ”€â”€ stop-bot.sh
â”‚   â””â”€â”€ restart-bot.sh
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.example                  # é…ç½®ç¤ºä¾‹
â”œâ”€â”€ go.mod
â””â”€â”€ Makefile
```

## æ ¸å¿ƒåŠŸèƒ½

### 1. æµå¼æ–‡æœ¬å¯¹è¯
- è°ƒç”¨æœ¬åœ° Claude CLI (`cc1` å‘½ä»¤)
- è§£æ `stream-json` æ ¼å¼è¾“å‡º
- å®æ—¶æå–æ–‡æœ¬å¢é‡
- æ™ºèƒ½åˆ†æ®µå‘é€ï¼ˆç©ºé—²è¶…æ—¶ + æœ€å¤§æŒç»­æ—¶é—´ï¼‰

### 2. æ¶ˆæ¯å¤„ç†
- WebSocket é•¿è¿æ¥æ¥æ”¶æ¶ˆæ¯
- æ”¯æŒå•èŠï¼ˆP2Pï¼‰å’Œç¾¤èŠ
- ç¾¤èŠéœ€è¦ @æœºå™¨äºº è§¦å‘
- è‡ªåŠ¨å›å¤ï¼Œæ— éœ€å‘½ä»¤å‰ç¼€

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿å·²å®‰è£…ï¼š
- Go 1.22.6+
- Claude CLIï¼ˆé…ç½®ä¸º `cc1` åˆ«åï¼‰

### 2. é…ç½®é£ä¹¦åº”ç”¨

1. è®¿é—® [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/app)
2. åˆ›å»ºè‡ªå»ºåº”ç”¨ï¼Œè·å– App ID å’Œ App Secret
3. é…ç½®æƒé™ï¼š
   - `im:message` - è·å–ä¸å‘é€æ¶ˆæ¯
   - `im:message:group_at_msg` - ç¾¤èŠ @æ¶ˆæ¯
   - `im:chat` - è®¿é—®ç¾¤èŠä¿¡æ¯
   - `cardkit:card:write` - åˆ›å»ºä¸æ›´æ–°å¡ç‰‡
4. é…ç½®äº‹ä»¶è®¢é˜…ï¼š
   - é€‰æ‹©"ä½¿ç”¨é•¿è¿æ¥æ¥æ”¶äº‹ä»¶"
   - æ·»åŠ äº‹ä»¶ï¼š`im.message.receive_v1`

### 3. é…ç½®é¡¹ç›®

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶
FEISHU_APP_ID=cli_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
FEISHU_APP_SECRET=your_app_secret
```

### 4. è¿è¡Œæœºå™¨äºº

```bash
# å®‰è£…ä¾èµ–
go mod download

# è¿è¡Œæœºå™¨äºº
go run cmd/bot/main.go
```

## ä½¿ç”¨æ–¹æ³•

### å‘èµ·å¯¹è¯

åœ¨é£ä¹¦ç¾¤èŠæˆ–ç§èŠä¸­ï¼š

```
@æœºå™¨äºº ä½ çš„é—®é¢˜
```

æœºå™¨äººä¼šï¼š
1. åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è¯å¡ç‰‡
2. æ˜¾ç¤º"æ€è€ƒä¸­..."
3. é€å­—æ˜¾ç¤º AI å›å¤ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰

### ç‰¹æ®Šå‘½ä»¤ï¼ˆç¾¤èŠä¸“ç”¨ï¼‰

åœ¨ç¾¤èŠä¸­ @æœºå™¨äºº æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç‰¹æ®Šå‘½ä»¤ï¼ˆä¸è½¬å‘ç»™ Claude CLIï¼‰ï¼š

#### 1. ls å‘½ä»¤ - åˆ—å‡ºé¡¹ç›®ç›®å½•

```
@æœºå™¨äºº ls
```

**åŠŸèƒ½**ï¼šåˆ—å‡ºåŸºç¡€ç›®å½•ä¸‹æ‰€æœ‰å¯ç»‘å®šçš„é¡¹ç›®ç›®å½•

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
ğŸ“‚ åŸºç¡€ç›®å½•: /Users/wen/Desktop/code/

å¯ç»‘å®šé¡¹ç›®ç›®å½•ï¼š
1. 01frp
2. 02v0.dev
3. 18feishu
...

å…± 33 ä¸ªç›®å½•
ä½¿ç”¨å‘½ä»¤: bind <åºå·>

âœ… å½“å‰ç»‘å®š: /Users/wen/Desktop/code/18feishu
```

#### 2. bind å‘½ä»¤ - ç»‘å®šé¡¹ç›®è·¯å¾„

```
@æœºå™¨äºº bind <åºå·>
```

**åŠŸèƒ½**ï¼šå°†å½“å‰ç¾¤èŠç»‘å®šåˆ°æŒ‡å®šé¡¹ç›®ç›®å½•ï¼ŒClaude CLI ä¼šåœ¨è¯¥ç›®å½•ä¸‹å¯åŠ¨

**ç¤ºä¾‹**ï¼š
```
@æœºå™¨äºº bind 18
```

**è¾“å‡º**ï¼š
```
âœ… å·²ç»‘å®šé¡¹ç›®è·¯å¾„: /Users/wen/Desktop/code/18feishu
ï¼ˆé…ç½®å·²ä¿å­˜ï¼‰
```

**è¯´æ˜**ï¼š
- ç»‘å®šåï¼ŒClaude CLI ä¼šä»¥è¯¥é¡¹ç›®ç›®å½•ä½œä¸ºå·¥ä½œç›®å½•å¯åŠ¨
- å¯ä»¥è®¿é—®é¡¹ç›®å†…çš„æ‰€æœ‰æ–‡ä»¶
- é…ç½®ä¼šæŒä¹…åŒ–ä¿å­˜åˆ° `configs/chat_config.json`
- æœºå™¨äººé‡å¯åç»‘å®šå…³ç³»ä¿æŒä¸å˜

#### 3. help å‘½ä»¤ - æ˜¾ç¤ºå¸®åŠ©

```
@æœºå™¨äºº help
```

**åŠŸèƒ½**ï¼šæ˜¾ç¤ºå‘½ä»¤å¸®åŠ©ä¿¡æ¯å’Œå½“å‰ç»‘å®šçŠ¶æ€

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
ğŸ¤– é£ä¹¦ Claude CLI æœºå™¨äººå‘½ä»¤è¯´æ˜

ç‰¹æ®Šå‘½ä»¤ï¼š
â€¢ ls - åˆ—å‡ºå¯ç»‘å®šçš„é¡¹ç›®ç›®å½•
â€¢ bind <åºå·> - ç»‘å®šç¾¤èŠåˆ°æŒ‡å®šé¡¹ç›®è·¯å¾„
â€¢ help - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ä½¿ç”¨ç¤ºä¾‹ï¼š
@æœºå™¨äºº ls
@æœºå™¨äºº bind 18
@æœºå™¨äºº help

æ³¨æ„ï¼š
- ç‰¹æ®Šå‘½ä»¤ä»…åœ¨ç¾¤èŠä¸­æœ‰æ•ˆ
- ç»‘å®šåé…ç½®ä¼šæŒä¹…åŒ–ä¿å­˜
- å…¶ä»–æ¶ˆæ¯å°†è½¬å‘ç»™ Claude å¤„ç†

âœ… å½“å‰ç»‘å®š: /Users/wen/Desktop/code/18feishu
```

### é…ç½®åŸºç¡€ç›®å½•

åŸºç¡€ç›®å½•ï¼ˆç”¨äº ls å‘½ä»¤æ‰«æé¡¹ç›®ï¼‰å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é…ç½®ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š

**æ–¹å¼ 1ï¼šç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰**

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š
```bash
BASE_DIR=/Users/wen/Desktop/code/
```

**æ–¹å¼ 2ï¼šé…ç½®æ–‡ä»¶**

ç¼–è¾‘ `configs/chat_config.json`ï¼š
```json
{
  "base_dir": "/Users/wen/Desktop/code/",
  "project_paths": {}
}
```

**æ–¹å¼ 3ï¼šé»˜è®¤å€¼**

å¦‚æœæœªé…ç½®ï¼Œé»˜è®¤ä½¿ç”¨ï¼š`/Users/wen/Desktop/code/`

### é…ç½®æ–‡ä»¶è¯´æ˜

ç»‘å®šä¿¡æ¯ä¿å­˜åœ¨ `configs/chat_config.json`ï¼š

```json
{
  "base_dir": "/Users/wen/Desktop/code/",
  "project_paths": {
    "oc_xxxxxxxxx": "/Users/wen/Desktop/code/18feishu",
    "oc_yyyyyyyyy": "/Users/wen/Desktop/code/other-project"
  }
}
```

- `base_dir`: åŸºç¡€ç›®å½•ï¼Œç”¨äºæ‰«æå¯ç»‘å®šçš„é¡¹ç›®
- `project_paths`: ç¾¤èŠ ID åˆ°é¡¹ç›®è·¯å¾„çš„æ˜ å°„å…³ç³»
- é…ç½®æ–‡ä»¶å·²åŠ å…¥ `.gitignore`ï¼Œä¸ä¼šè¢«æäº¤åˆ° Git

### ç¤ºä¾‹å¯¹è¯

```
ç”¨æˆ·: @æœºå™¨äºº å¦‚ä½•ç”¨ Go å®ç° HTTP æœåŠ¡å™¨ï¼Ÿ

æœºå™¨äºº: [åˆ›å»ºå¡ç‰‡]
      [æµå¼æ›´æ–°å†…å®¹]
      åœ¨ Go ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†åº“çš„ net/http åŒ…...
```

### ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

**åœºæ™¯ 1ï¼šå¤šé¡¹ç›®ç®¡ç†**

```
# å¼€å‘å›¢é˜Ÿ A çš„ç¾¤èŠ
@æœºå™¨äºº bind 1    # ç»‘å®šåˆ° project-a
@æœºå™¨äºº å¸®æˆ‘é‡æ„è¿™ä¸ªå‡½æ•°  # Claude åœ¨ project-a ç›®å½•ä¸‹å·¥ä½œ

# å¼€å‘å›¢é˜Ÿ B çš„ç¾¤èŠ
@æœºå™¨äºº bind 2    # ç»‘å®šåˆ° project-b
@æœºå™¨äºº å†™ä¸ªå•å…ƒæµ‹è¯•  # Claude åœ¨ project-b ç›®å½•ä¸‹å·¥ä½œ
```

**åœºæ™¯ 2ï¼šå¿«é€ŸæŸ¥çœ‹é¡¹ç›®**

```
@æœºå™¨äºº ls        # æŸ¥çœ‹æ‰€æœ‰å¯ç»‘å®šé¡¹ç›®
@æœºå™¨äºº bind 18   # ç»‘å®šåˆ° 18feishu é¡¹ç›®
@æœºå™¨äºº åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶  # Claude è®¿é—® 18feishu é¡¹ç›®
```

## æŠ€æœ¯å®ç°

### Claude CLI é›†æˆ

```go
// å¯åŠ¨ Claude CLI è¿›ç¨‹
cmd := exec.Command("cc1",
    "-p",                                // éäº¤äº’æ¨¡å¼
    "--output-format", "stream-json",    // æµå¼ JSON è¾“å‡º
    "--include-partial-messages",        // åŒ…å«éƒ¨åˆ†æ¶ˆæ¯
)

// è§£ææµå¼è¾“å‡º
// {"type": "stream_event", "event": {"type": "content_block_delta", "delta": {"text": "..."}}}
```

### CardKit æµå¼æ›´æ–°

```go
// 1. åˆ›å»ºå¡ç‰‡å®ä½“
POST /open-apis/cardkit/v1/cards

// 2. å‘é€å¡ç‰‡åˆ°ç¾¤èŠ
POST /open-apis/im/v1/messages

// 3. æµå¼æ›´æ–°å¡ç‰‡å†…å®¹ï¼ˆé™æµ 100msï¼‰
PUT /open-apis/cardkit/v1/cards/{card_id}/elements/{element_id}/content
```

### WebSocket é•¿è¿æ¥

```go
wsClient := larkws.NewClient(appID, appSecret,
    larkws.WithEventHandler(eventHandler),
    larkws.WithLogLevel(larkcore.LogLevelInfo),
)
wsClient.Start(context.Background())
```

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `FEISHU_APP_ID` | é£ä¹¦åº”ç”¨ ID | `cli_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx` |
| `FEISHU_APP_SECRET` | é£ä¹¦åº”ç”¨å¯†é’¥ | `Y0psnqB52LC50Svx...` |
| `BASE_DIR` | åŸºç¡€é¡¹ç›®ç›®å½•ï¼ˆç”¨äº ls å’Œ bind å‘½ä»¤ï¼‰ | `/Users/wen/Desktop/code/` |
| `GROUP_REQUIRE_MENTION` | ç¾¤èŠæ˜¯å¦å¿…é¡»@æœºå™¨äººï¼ˆé»˜è®¤ falseï¼‰ | `false` |

### CardKit æ‰“å­—æœºæ•ˆæœ

```json
{
  "config": {
    "streaming_mode": true,
    "streaming_config": {
      "print_frequency_ms": {"default": 70},
      "print_step": {"default": 1},
      "print_strategy": "fast"
    }
  }
}
```

## å¼€å‘çŠ¶æ€

âœ… å·²å®Œæˆï¼š
- [x] Claude CLI è¿›ç¨‹ç®¡ç†
- [x] Stream-JSON è§£æå™¨
- [x] CardKit æµå¼æ›´æ–°ï¼ˆé™æµ 10 QPSï¼‰
- [x] é£ä¹¦æ¶ˆæ¯å¤„ç†é›†æˆ
- [x] WebSocket é•¿è¿æ¥
- [x] ç›´æ¥æ¶ˆæ¯è§¦å‘å¯¹è¯ï¼ˆæ— éœ€ /chatï¼‰
- [x] æ‰“å­—æœºæ•ˆæœ

â³ è°ƒè¯•ä¸­ï¼š
- [ ] é£ä¹¦å¹³å°äº‹ä»¶è®¢é˜…é…ç½®

## å¸¸è§é—®é¢˜

### 1. å¹³å°æ˜¾ç¤º"åº”ç”¨æœªå»ºç«‹é•¿è¿æ¥"

**ç—‡çŠ¶**ï¼šæœºå™¨äººæ—¥å¿—æ˜¾ç¤º `connected`ï¼Œä½†é£ä¹¦å¹³å°æ˜¾ç¤ºæœªå»ºç«‹é•¿è¿æ¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å³ä½¿æç¤ºæœªå»ºç«‹è¿æ¥ï¼Œä¹Ÿå¼ºåˆ¶ä¿å­˜äº‹ä»¶è®¢é˜…é…ç½®
2. é‡å¯æœºå™¨äºº
3. ç­‰å¾… 2-3 åˆ†é’Ÿåˆ·æ–°é¡µé¢
4. æˆ–ç›´æ¥åœ¨ç¾¤é‡Œæµ‹è¯•ï¼Œçœ‹æ˜¯å¦èƒ½æ”¶åˆ°æ¶ˆæ¯

### 2. æœºå™¨äººæ— å“åº”

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æœºå™¨äººè¿›ç¨‹æ˜¯å¦è¿è¡Œ
- [ ] WebSocket æ—¥å¿—æ˜¯å¦æ˜¾ç¤º `connected`
- [ ] äº‹ä»¶è®¢é˜…æ˜¯å¦é…ç½®æˆåŠŸ
- [ ] æƒé™æ˜¯å¦å·²å¼€å¯

### 3. CardKit æ›´æ–°å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- è¶…è¿‡ 10 QPS é™æµ
- token è¿‡æœŸ
- card_id æˆ– element_id é”™è¯¯

## æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æœºå™¨äººæ—¥å¿—
tail -f /tmp/feishu-bot.log

# æœç´¢é”™è¯¯
grep "ERROR" /tmp/feishu-bot.log

# æ£€æŸ¥ WebSocket è¿æ¥
grep "connected" /tmp/feishu-bot.log
```

## ç›¸å…³èµ„æº

- [é£ä¹¦å¼€æ”¾å¹³å°æ–‡æ¡£](https://open.feishu.cn/document)
- [CardKit 2.0 æŒ‡å—](https://open.feishu.cn/document/common-capabilities/message-card/card-components)
- [Claude CLI æ–‡æ¡£](https://docs.anthropic.com/claude-cli/overview)
- [é£ä¹¦ Go SDK](https://github.com/larksuite/oapi-sdk-go)

## è®¸å¯è¯

MIT License
