# é£žä¹¦åº”ç”¨é…ç½®å¿«é€Ÿå¯åŠ¨æŒ‡å—

## ðŸ“‹ é…ç½®æ¸…å•

åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿ä½ å‡†å¤‡å¥½äº†ï¼š
- [ ] é£žä¹¦è´¦å·ï¼ˆç®¡ç†å‘˜æˆ–å¯åˆ›å»ºåº”ç”¨çš„æƒé™ï¼‰
- [ ] æµ‹è¯•ç¾¤èŠï¼ˆå¯ä»¥æ˜¯ä»»æ„ç¾¤ï¼‰
- [ ] ç»ˆç«¯è®¿é—®æƒé™

---

## ðŸš€ 5 æ­¥é…ç½®ï¼ˆçº¦ 5-10 åˆ†é’Ÿï¼‰

### æ­¥éª¤ 1ï¼šåˆ›å»ºé£žä¹¦åº”ç”¨ï¼ˆ2 åˆ†é’Ÿï¼‰

1. è®¿é—®ï¼šhttps://open.feishu.cn/app
2. ç‚¹å‡»"åˆ›å»ºè‡ªå»ºåº”ç”¨"
3. å¡«å†™ä¿¡æ¯ï¼š
   - åº”ç”¨åç§°ï¼š`Claude Stream Bot`
   - åº”ç”¨æè¿°ï¼š`Claude Code æµå¼å¯¹è¯æœºå™¨äºº`
4. åˆ›å»ºæˆåŠŸåŽï¼Œå¤åˆ¶ï¼š
   - **App ID**ï¼ˆæ ¼å¼ï¼š`cli_xxxxx`ï¼‰
   - **App Secret**ï¼ˆç‚¹å‡»"æŸ¥çœ‹"åŽå¤åˆ¶ï¼‰

### æ­¥éª¤ 2ï¼šé…ç½®æƒé™ï¼ˆ2 åˆ†é’Ÿï¼‰

åœ¨åº”ç”¨é¡µé¢ï¼š

1. å·¦ä¾§èœå• â†’ "æƒé™ç®¡ç†"
2. æœç´¢å¹¶å‹¾é€‰ä»¥ä¸‹æƒé™ï¼š
   - `im:message`
   - `im:message:group_at_msg`
   - `im:message:send_as_bot`
   - `im:chat`
   - `card:card`ï¼ˆæœç´¢ "card"ï¼Œå…¨éƒ¨å‹¾é€‰ï¼‰
3. ç‚¹å‡»å³ä¸Šè§’"å‘å¸ƒ" â†’ "å…¨å‘˜å¯ä½¿ç”¨" â†’ "ç¡®å®š"

### æ­¥éª¤ 3ï¼šèŽ·å–æµ‹è¯•ç¾¤èŠ IDï¼ˆ1 åˆ†é’Ÿï¼‰

åœ¨é£žä¹¦å®¢æˆ·ç«¯ï¼š

1. åˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªæµ‹è¯•ç¾¤èŠ
2. å³é”®ç¾¤èŠ â†’ "ç¾¤è®¾ç½®" â†’ "ç¾¤ä¿¡æ¯"
3. å¤åˆ¶ **"ç¾¤ ID"**ï¼ˆæ ¼å¼ï¼š`oc_xxxxx`ï¼‰

### æ­¥éª¤ 4ï¼šé…ç½®çŽ¯å¢ƒå˜é‡ï¼ˆ1 åˆ†é’Ÿï¼‰

åœ¨ç»ˆç«¯è¿è¡Œï¼š

```bash
# è®¾ç½®é£žä¹¦å‡­è¯ï¼ˆæ›¿æ¢ä¸ºä½ å¤åˆ¶çš„å€¼ï¼‰
export FEISHU_APP_ID="cli_xxxxx"
export FEISHU_APP_SECRET="your_app_secret_here"
export FEISHU_TEST_CHAT_ID="oc_xxxxx"
```

æˆ–è€…åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cd /Users/wen/Desktop/code/18feishu

cat > .env <<EOF
FEISHU_APP_ID=cli_xxxxx
FEISHU_APP_SECRET=your_app_secret_here
FEISHU_TEST_CHAT_ID=oc_xxxxx
PORT=8080
EOF
```

### æ­¥éª¤ 5ï¼šè¿è¡Œæµ‹è¯•ï¼ˆ2 åˆ†é’Ÿï¼‰

**ç¡®ä¿å·²å®‰è£… jqï¼ˆJSON å¤„ç†å·¥å…·ï¼‰ï¼š**
```bash
# macOS
brew install jq

# Linux
sudo apt-get install jq
```

**è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š**
```bash
cd /Users/wen/Desktop/code/18feishu/test
./test_feishu_api.sh
```

---

## âœ… é¢„æœŸç»“æžœ

å¦‚æžœé…ç½®æ­£ç¡®ï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

```
==========================================
  é£žä¹¦ CardKit 2.0 æµå¼æ›´æ–° API æµ‹è¯•
==========================================

âžœ æ£€æŸ¥çŽ¯å¢ƒå˜é‡...
âœ“ çŽ¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡
  App ID: cli_xxxxx
  Chat ID: oc_xxxxx

âžœ èŽ·å– tenant_access_token...
âœ“ Token èŽ·å–æˆåŠŸ
  Token: t-xxxxxxxxxxxx...
  æœ‰æ•ˆæœŸ: 7200 ç§’

âžœ æµ‹è¯• 1: åˆ›å»ºæµå¼å¡ç‰‡...
âœ“ å¡ç‰‡åˆ›å»ºæˆåŠŸ
  Card ID: om_xxxxx
  Element ID: reply_content
  UUID: test-uuid-xxxxx

âžœ æµ‹è¯• 2: æµå¼æ›´æ–°å¡ç‰‡å†…å®¹...
âžœ æ›´æ–° 1: "Hello"
âœ“ æ›´æ–°æˆåŠŸ
âžœ æ›´æ–° 2: "Hello there"
âœ“ æ›´æ–°æˆåŠŸ
...

==========================================
âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
==========================================

è¯·åœ¨é£žä¹¦ç¾¤èŠä¸­æŸ¥çœ‹å¡ç‰‡ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ‰“å­—æœºæ•ˆæžœã€‚
```

**åœ¨é£žä¹¦ç¾¤èŠä¸­**ï¼Œä½ åº”è¯¥çœ‹åˆ°ä¸€å¼ å¡ç‰‡ï¼Œå†…å®¹ä»Ž"æ€è€ƒä¸­..."é€æ¸å˜ä¸º "Hello there! This is a streaming test."

è¿™å°±æ˜¯æˆ‘ä»¬è¦éªŒè¯çš„æ‰“å­—æœºæ•ˆæžœï¼âœ¨

---

## âŒ é‡åˆ°é”™è¯¯ï¼Ÿ

### é”™è¯¯ 1ï¼šæƒé™ä¸è¶³
```
âœ— åˆ›å»ºå¡ç‰‡å¤±è´¥
{
  "code": 99991663,
  "msg": "app has no permission"
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æƒé™ç®¡ç†ï¼Œç¡®ä¿å‹¾é€‰äº†æ‰€æœ‰å¿…éœ€æƒé™
2. ç¡®ä¿ç‚¹å‡»äº†"å‘å¸ƒ"æŒ‰é’®
3. ç­‰å¾… 1-2 åˆ†é’Ÿè®©æƒé™ç”Ÿæ•ˆ

### é”™è¯¯ 2ï¼šAPI ä¸å­˜åœ¨
```
âœ— æ›´æ–°å¤±è´¥ (sequence=1)
{
  "code": 404,
  "msg": "api not found"
}
```

**å¯èƒ½åŽŸå› **ï¼šCardKit 2.0 API å¯èƒ½è¿˜æœªå®Œå…¨å¼€æ”¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥é£žä¹¦å¼€æ”¾å¹³å°çš„ CardKit æ–‡æ¡£
2. ç¡®è®¤ä½ çš„åº”ç”¨æ˜¯å¦æœ‰ CardKit æƒé™
3. å¦‚æžœä¸å¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆï¼ˆæ¶ˆæ¯ patch APIï¼‰

### é”™è¯¯ 3ï¼šç¾¤èŠ ID é”™è¯¯
```
âœ— åˆ›å»ºå¡ç‰‡å¤±è´¥
{
  "code": 11111541,
  "msg": "invalid chat id"
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ Chat ID æ ¼å¼æ­£ç¡®ï¼ˆ`oc_xxxxx`ï¼‰
2. ç¡®ä¿æœºå™¨äººå·²åŠ å…¥è¯¥ç¾¤èŠ
3. å°è¯•é‡æ–°å¤åˆ¶ç¾¤ IDï¼ˆå¯èƒ½å¤åˆ¶é”™äº†ï¼‰

---

## ðŸ” æ‰‹åŠ¨æµ‹è¯•ï¼ˆå¦‚æžœè„šæœ¬è¿è¡Œå¤±è´¥ï¼‰

### æµ‹è¯• 1ï¼šèŽ·å– Token

```bash
curl -X POST "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal" \
  -H "Content-Type: application/json" \
  -d '{
    "app_id": "ä½ çš„AppID",
    "app_secret": "ä½ çš„Secret"
  }'
```

æœŸæœ›è¿”å›žï¼š`{"code": 0, "tenant_access_token": "t-xxxx", ...}`

### æµ‹è¯• 2ï¼šåˆ›å»ºå¡ç‰‡

```bash
TOKEN="ä»Žä¸Šä¸€æ­¥èŽ·å–çš„token"

curl -X POST "https://open.feishu.cn/open-apis/im/v1/messages" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "receive_id": "oc_xxxxx",
    "msg_type": "interactive",
    "content": "{\"schema\":\"2.0\",\"config\":{\"wide_screen_mode\":true,\"streaming_mode\":true,\"update_multi\":true},\"elements\":[{\"tag\":\"markdown\",\"element_id\":\"reply_content\",\"uuid\":\"test-123\",\"content\":\"æ€è€ƒä¸­...\"}]}"
  }'
```

æœŸæœ›è¿”å›žï¼š`{"code": 0, "data": {"message_id": "om_xxxxx"}, ...}`

### æµ‹è¯• 3ï¼šæ›´æ–°å¡ç‰‡

```bash
CARD_ID="ä»Žä¸Šä¸€æ­¥èŽ·å–çš„message_id"

curl -X PUT "https://open.feishu.cn/open-apis/cardkit/v1/cards/$CARD_ID/elements/reply_content/content" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "test-123",
    "content": "Hello!",
    "sequence": 1
  }'
```

æœŸæœ›è¿”å›žï¼š`{"code": 0}`

---

## ðŸ“ å®ŒæˆåŽçš„ä¸‹ä¸€æ­¥

é…ç½®å®ŒæˆåŽï¼Œè¯·å‘Šè¯‰æˆ‘æµ‹è¯•ç»“æžœï¼š

### âœ… å¦‚æžœæµ‹è¯•æˆåŠŸ

å¤ªå¥½äº†ï¼CardKit 2.0 API å¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å¼€å‘ï¼š
1. å®žçŽ°ç¼“å†²å’Œé™æµå™¨æ¨¡å—
2. é›†æˆ Claude CLI è¿›ç¨‹ç®¡ç†
3. å®žçŽ°å®Œæ•´çš„ Webhook å¤„ç†
4. ç«¯åˆ°ç«¯æµ‹è¯•

### âŒ å¦‚æžœæµ‹è¯•å¤±è´¥

ä¸è¦æ‹…å¿ƒï¼æˆ‘ä»¬æœ‰å¤‡é€‰æ–¹æ¡ˆï¼š
1. **æ–¹æ¡ˆ A**ï¼šä½¿ç”¨ä¼ ç»Ÿçš„æ¶ˆæ¯ patch API
2. **æ–¹æ¡ˆ B**ï¼šä½¿ç”¨å¤šæ¬¡æ¶ˆæ¯æ›´æ–°
3. **æ–¹æ¡ˆ C**ï¼šç­‰å¾… CardKit 2.0 å®Œå…¨å¼€æ”¾

---

## ðŸ“š å‚è€ƒæ–‡æ¡£

- é£žä¹¦å¼€æ”¾å¹³å°ï¼šhttps://open.feishu.cn
- CardKit æ–‡æ¡£ï¼šhttps://open.feishu.cn/document/cardkit-v1/streaming-updates-openapi-overview
- æƒé™è¯´æ˜Žï¼šhttps://open.feishu.cn/document/ukTMukTMukTM/uUTNz4SN1MjL1UzM

---

## ðŸ’¬ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼š
1. å…·ä½“çš„é”™è¯¯ä¿¡æ¯
2. è¿è¡Œçš„å‘½ä»¤
3. è¿”å›žçš„ç»“æžœ

æˆ‘ä¼šå¸®ä½ è§£å†³ï¼ðŸš€
