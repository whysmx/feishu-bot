# 飞书 Claude 机器人 - 交互设计文档

## 设计理念

**核心思想**：简洁直观，尽量让用户以自然对话方式使用。

## 1. 命令设计原则

### 原则 1：群聊命令需要 @ 机器人

**设计决策**：仅在群聊中 `@机器人` 且命令词匹配时，才进入命令模式。

**行为定义**：
- `@机器人 ls` / `@机器人 bind 1` / `@机器人 help` → 执行命令
- 其他消息 → 直接转发给 Claude CLI（无论是否 @）

**实现要点**：
```go
if isMentioned {
    cmdType, cmdArgs, isCmd := parseCommand(trimmedContent)
    if isCmd {
        // 处理 ls/bind/help
    }
}
// 其他情况 → 转发给 Claude CLI
```

### 原则 2：去斜杠化，自然语言交互

**设计决策**：命令不需要 `/` 前缀，直接使用自然语言关键词。

**示例**：
```
@机器人 bind 1
@机器人 ls
@机器人 help
```

### 原则 3：bind 仅支持序号

**设计决策**：`bind` 只接受 `ls` 返回的序号，避免输入路径出错。

**示例**：
```
@机器人 bind 3
```

**说明**：路径绑定与展开属于未来扩展方向，当前未实现。

## 2. 信息展示设计

### 列表展示：基础目录 + 序号

**输出格式**：
```
📂 基础目录: /Users/wen/Desktop/code/

可绑定项目目录：
1. 18feishu
2. project-b

共 2 个目录
使用命令: bind <序号>
```

**设计要点**：
1. **序号从 1 开始**：符合人类习惯
2. **目录名展示**：避免过长路径占用屏幕
3. **基础目录单独显示**：让用户知道完整路径前缀

### 帮助信息：上下文相关

**已绑定时**：
```
✅ 当前绑定: /Users/wen/Desktop/code/18feishu
```

**未绑定时**：
```
⚠️ 当前未绑定项目路径
```

## 3. 错误处理设计

**序号超出范围**：
```
❌ 序号超出范围，最大序号: 5
```

**用法错误**：
```
❌ 请提供项目序号
使用命令: bind <序号>
```

**设计原则**：
1. **错误原因明确**：用户知道哪里错了
2. **解决方法清晰**：提示正确格式
3. **返回即时**：避免进入 Claude CLI

## 4. 对话模式分离

| 场景 | 触发方式 | 行为 | 示例 |
|------|----------|------|------|
| **命令模式** | 群聊 `@机器人` + 命令词 | 执行命令 | `@机器人 ls` |
| **对话模式** | 其他消息 | 转发给 Claude CLI | `帮我看看这个项目` |

### 群聊 vs 私聊

**群聊**：
- 支持项目绑定
- 绑定后 Claude CLI 在项目目录运行
- 命令需要 @ 机器人触发

**私聊**：
- 不支持项目绑定
- 使用机器人运行目录作为默认工作目录
- 直接对话，不要求 @

## 5. 配置文件设计

### 存储位置
```
configs/chat_config.json
```

### 文件格式
```json
{
  "base_dir": "/Users/wen/Desktop/code/",
  "project_paths": {
    "oc_61cb6d77fa53eeee339c2195868e64d1": "/Users/wen/Desktop/code/18feishu"
  }
}
```

**设计要点**：
1. **简单映射**：`chat_id` → `project_path`
2. **持久化**：重启后绑定关系保留
3. **环境变量优先**：`BASE_DIR` 会覆盖文件中的 `base_dir`

## 6. 会话与流式输出

- **P2P**：按用户维持会话，优先使用 `--resume`。
- **群聊**：使用全局会话 ID，共享上下文。
- **流式输出**：基于空闲超时、最大持续时间、最大缓冲区分段发送文本消息。

## 7. 设计演进历史

### v1.0：CardKit 方式（已废弃）
```
@机器人 问题
→ 创建卡片 → 流式更新 → 多次 API 调用
```

### v2.0：文本消息方式（当前）
```
@机器人 bind 1  → 直接回复文本
问题           → 流式分段发送文本
```

**优势**：
- API 调用少
- 实现简单
- 限流风险低

## 8. 未来扩展方向（可选）

1. **路径绑定**：允许 `bind /path/to/project`
2. **命令别名**：`绑定`、`b` 等中文/缩写
3. **解绑与重命名**：`unbind`、`rename`
4. **更细粒度会话管理**：按群聊单独会话
