# 开发任务清单

本文档记录当前项目的问题、待完成任务和优先级。

## 🔴 高优先级问题

### 1. 飞书平台事件推送问题 ⭐⭐⭐

**问题描述**：
- Bot 成功建立 WebSocket 长连接
- 事件订阅配置已保存（`im.message.receive_v1`）
- **但飞书平台没有推送任何事件到 Bot**
- 事件日志显示"暂无数据"
- Bot 日志中只有连接记录，没有消息处理记录

**影响**：Bot 完全无法工作，无法接收和处理任何消息

**排查步骤**：
- ✅ Bot 进程正常运行
- ✅ WebSocket 连接成功
- ✅ 事件订阅已配置
- ✅ 飞书平台可推送事件（见“已确认”）

**可能原因**：
1. 飞书平台需要时间识别长连接（已等待 5+ 分钟无效果）
2. 长连接状态未被平台正确识别
3. 应用配置未正确发布
4. 权限配置问题
5. 事件订阅配置需要重新保存
6. **测试方式错误：纯文本“@机器人”不会生成 mention 实体**

**下一步行动**：
1. 联系飞书技术支持
2. 尝试删除并重新添加事件订阅
3. 检查应用版本发布状态
4. 使用 HTTP 回调方式测试（备选方案）
5. **用真实 @mention 触发事件（见“已确认”）**

**相关文件**：
- `cmd/bot/main.go` - WebSocket 连接启动
- `internal/bot/client/feishu.go` - 长连接管理

**已确认**：
- ✅ 长连接可正常接收事件
- ✅ 关键点：必须使用“真实 @mention”（按 `@` 选择机器人）才会触发 `im.message.receive_v1`
- ❗️用 MCP `fill` 或粘贴文本 `@Claude Stream Bot` 不会生成 mention 实体，事件不会推送
- ✅ 日志出现 `receive message` 与 `OnP2MessageReceiveV1` 后，处理链路正常

**状态**：✅ 已解决（测试方式误用导致“无事件推送”的假象）

---

## 🟡 中优先级任务

### 2. 测试流式对话功能

**状态**：代码已完成，无法测试（因为问题 #1）

**待测试内容**：
- ✅ 代码已实现（`internal/claude/`）
- ❌ 无法测试消息接收
- ❌ 无法测试 Claude CLI 启动
- ❌ 无法测试 CardKit 卡片创建
- ❌ 无法测试流式更新

**测试计划**（问题 #1 解决后）：
1. 发送简单消息："你好"
2. 发送复杂问题："解释 Go 的协程机制"
3. 验证卡片创建和更新
4. 验证流式输出的打字机效果
5. 验证错误处理

**相关文件**：
- `internal/claude/handler.go` - 流式对话处理
- `internal/claude/manager.go` - Claude CLI 管理
- `internal/claude/cardkit_updater.go` - 卡片更新

---

### 3. 优化 @Mention 清理逻辑

**状态**：部分完成，需要更多测试

**已完成**：
- ✅ 支持 `@BotName /chat content` 格式
- ✅ 支持 `@BotName\n/chat content` 格式
- ✅ 支持 `/chat` 后面直接跟换行的情况

**待优化**：
- ⚠️ 需要测试更多边界情况
- ⚠️ 可能存在其他 @mention 格式
- ⚠️ 群聊中的 @mention 可能更复杂

**建议**：
1. 收集更多真实消息样本
2. 添加单元测试
3. 使用正则表达式简化逻辑

**相关文件**：
- `internal/bot/handlers/message.go:283-326` - `cleanMentionContent` 函数

---

### 4. 完善错误处理

**当前状态**：
- ✅ 基本的错误日志
- ⚠️ 缺少用户友好的错误提示
- ⚠️ 某些错误场景未处理

**待改进**：
1. Claude CLI 启动失败的处理
2. 流式输出中断的处理
3. CardKit API 调用失败的重试机制
4. 超时处理

**示例场景**：
- Claude CLI 未安装或路径错误
- API 调用超时
- WebSocket 连接断开
- 内存不足

---

## 🟢 低优先级任务

### 5. 改进帮助信息

**状态**：已更新一次，可以继续优化

**已完成**：
- ✅ 移除 /chat 前缀要求
- ✅ 更新使用示例

**可改进**：
- 添加更多使用示例
- 添加常见问题解答
- 改进排版和可读性
- 添加表情符号增加友好度

**相关文件**：
- `internal/bot/handlers/message.go:362-393` - `sendHelpMessage` 函数

---

### 6. 实现远程命令功能

**状态**：只有 Mock 实现

**当前代码**：
```go
// 暂时使用mock实现
mh.logger.Printf("Mock: Would execute command %s for token %s", command, token)

// 模拟成功响应
resultMessage := fmt.Sprintf("✅ 命令执行成功\n\n令牌: %s\n命令: %s\n方法: mock\n耗时: 100ms",
    token, command)
```

**需要实现**：
1. 验证令牌有效性
2. 检查用户权限
3. 执行实际的命令
4. 返回执行结果
5. 安全检查（防止危险命令）

**相关文件**：
- `internal/bot/handlers/message.go:172-214` - 远程命令处理

---

### 7. 添加会话管理功能

**状态**：接口已定义，未实现

**已有代码**：
```go
sessions, err := mh.sessionManager.ListSessions(userID)
```

**需要实现**：
1. 会话创建和销毁
2. 会话状态管理
3. 会话持久化
4. 会话超时处理

**相关文件**：
- `internal/session/` - 会话管理模块

---

### 8. 添加通知功能

**状态**：接口已定义，未实现

**已有代码**：
```go
mh.notificationSender
```

**需要实现**：
1. 消息发送接口
2. 通知模板
3. 通知队列
4. 失败重试

**相关文件**：
- `internal/notification/` - 通知模块

---

### 9. 编写单元测试

**状态**：暂无测试

**需要测试的模块**：
1. `cleanMentionContent` 函数
2. `extractTextContent` 函数
3. `isRemoteCommand` 函数
4. 消息路由逻辑
5. 错误处理

**目标覆盖率**：> 80%

---

### 10. 性能优化

**待优化项**：
1. 减少内存分配
2. 优化字符串处理
3. 连接池管理
4. 缓存优化
5. 并发处理

**性能指标**：
- 消息处理延迟：< 100ms
- 内存使用：< 100MB
- CPU 使用：< 10%（空闲时）

---

## 📊 已完成的改进

### ✅ 简化对话命令
- **之前**：需要使用 `/chat 问题`
- **现在**：直接 `@机器人 问题` 即可
- **影响**：用户体验更自然

### ✅ 修复 Claude CLI 路径问题
- **之前**：使用 `cc1` shell 别名
- **现在**：使用完整路径 `/Users/wen/.npm-global/bin/claude`
- **影响**：避免命令找不到错误

### ✅ 添加调试日志
- 添加 `[DEBUG]` 日志用于问题定位
- 记录原始消息内容和清理后内容
- 便于快速定位问题

### ✅ 多进程问题处理
- 发现多个 bot 进程同时运行的问题
- 提供清理和重启脚本
- 避免旧代码干扰测试

---

## 🎯 里程碑目标

### Milestone 1: 基础功能可用 ⭐⭐⭐
- [x] Bot 能够接收消息
- [x] Bot 能够回复消息
- [ ] 流式对话功能正常工作
- [ ] CardKit 卡片正常显示和更新

**当前状态**：事件推送已确认正常，后续验证流式对话与卡片更新

### Milestone 2: 完善核心功能
- [ ] 远程命令执行
- [ ] 会话管理
- [ ] 错误处理完善
- [ ] 性能优化

### Milestone 3: 生产就绪
- [ ] 单元测试覆盖率 > 80%
- [ ] 完整文档
- [ ] 监控和日志
- [ ] 部署脚本

---

## 🐛 已知 Bug

### Bug #1: 空消息处理
- **描述**：当 `/chat` 后面只有换行符时，用户消息为空
- **状态**：✅ 已修复
- **修复**：返回命令前缀本身而不是空字符串

### Bug #2: 帮助信息未更新
- **描述**：移除 /chat 要求后，帮助信息仍然显示需要 /chat
- **状态**：✅ 已修复
- **修复**：更新帮助信息为直接 @机器人

### Bug #3: 多进程冲突
- **描述**：多个 bot 进程运行时，旧代码仍在工作
- **状态**：✅ 已识别
- **解决方案**：使用 `pkill` 清理所有进程后重启

---

## 📝 待讨论的设计问题

### 1. 令牌生成策略
- 当前：未实现
- 需要确定：令牌长度、有效期、生成算法

### 2. 会话存储
- 当前：未实现
- 需要确定：存储方式（内存/文件/数据库）

### 3. 命令白名单
- 当前：未实现
- 需要确定：哪些命令允许执行，哪些需要拦截

### 4. 并发控制
- 当前：未实现
- 需要确定：单个用户同时发起多个对话的处理方式

### 5. 监控指标
- 当前：只有基本日志
- 需要确定：需要收集哪些指标，如何展示

---

## 🔗 相关资源

- **测试指南**：[TESTING_GUIDE.md](./TESTING_GUIDE.md)
- **Chrome MCP 测试**：[CHROME_MCP_TESTING.md](./CHROME_MCP_TESTING.md)
- **飞书配置指南**：[FEISHU_SETUP_GUIDE.md](./FEISHU_SETUP_GUIDE.md)
- **项目 README**：[../README.md](../README.md)

---

## 📅 更新记录

### 2026-01-02
- 创建任务清单文档
- 记录飞书平台事件推送问题
- 整理待完成功能
- 记录已完成改进

---

## 🎯 当前重点

**最紧急任务**：解决飞书平台事件推送问题（问题 #1）

这是阻塞所有其他任务的关键问题，需要优先解决。建议：
1. 联系飞书技术支持
2. 尝试重新配置事件订阅
3. 测试 HTTP 回调方式作为备选方案
4. 检查是否有应用配置遗漏
