# é£ä¹¦æœºå™¨äººé…ç½®å®Œæ•´æŒ‡å—

æœ¬æ–‡æ¡£è®°å½•äº†é£ä¹¦æœºå™¨äººæ‰€éœ€çš„å®Œæ•´é…ç½®é¡¹ï¼Œæ–¹ä¾¿å…¶ä»–é¡¹ç›®å¤ç”¨ã€‚

## ğŸ“‹ é…ç½®æ¸…å•

### 1. åˆ›å»ºåº”ç”¨

**è®¿é—®åœ°å€**ï¼šhttps://open.feishu.cn/app

**æ­¥éª¤**ï¼š
1. ç‚¹å‡»"åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨"
2. é€‰æ‹©åº”ç”¨ç±»å‹ï¼šä¼ä¸šè‡ªå»ºåº”ç”¨
3. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
   - åº”ç”¨åç§°ï¼šClaude Stream Botï¼ˆæˆ–è‡ªå®šä¹‰åç§°ï¼‰
   - åº”ç”¨æè¿°ï¼šClaude CLI æµå¼å¯¹è¯æœºå™¨äºº
4. åˆ›å»ºåè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **App ID**ï¼š`cli_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`ï¼ˆç¤ºä¾‹ï¼‰
   - **App Secret**ï¼šä»"å‡­è¯ä¸åŸºç¡€ä¿¡æ¯"é¡µé¢è·å–

### 2. é…ç½®æƒé™

**è®¿é—®åœ°å€**ï¼šhttps://open.feishu.cn/app/cli_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/auth

**å¿…éœ€æƒé™**ï¼š

| æƒé™åç§° | æƒé™ID | ç”¨é€” | çŠ¶æ€ |
|---------|--------|------|------|
| è·å–ä¸å‘é€å•èŠã€ç¾¤ç»„æ¶ˆæ¯ | `im:message` | æ¥æ”¶å’Œå‘é€æ¶ˆæ¯ | âœ… å¿…éœ€ |
| ç¾¤èŠä¸­@æ¶ˆæ¯çš„æ¥æ”¶ | `im:message.group_at_msg` | æ¥æ”¶ç¾¤èŠ@æ¶ˆæ¯ | âœ… å¿…éœ€ |
| è®¿é—®ç¾¤èŠä¿¡æ¯ | `im:chat` | è®¿é—®ç¾¤ç»„ä¿¡æ¯ | âœ… å¿…éœ€ |
| åˆ›å»ºä¸æ›´æ–°å¡ç‰‡ | `cardkit:card:write` | CardKit æµå¼æ›´æ–° | âœ… å¿…éœ€ |

**é…ç½®æ­¥éª¤**ï¼š
1. è®¿é—®æƒé™ç®¡ç†é¡µé¢
2. æœç´¢å¹¶å¯ç”¨ä¸Šè¿°4ä¸ªæƒé™
3. ç‚¹å‡»"ä¿å­˜"
4. ï¼ˆé‡è¦ï¼‰**å‘å¸ƒç‰ˆæœ¬**ï¼šæƒé™ä¿®æ”¹åéœ€è¦åˆ›å»ºç‰ˆæœ¬æ‰èƒ½ç”Ÿæ•ˆ

### 3. é…ç½®äº‹ä»¶è®¢é˜…

**è®¿é—®åœ°å€**ï¼šhttps://open.feishu.cn/app/cli_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/event

**è®¢é˜…æ–¹å¼**ï¼šä½¿ç”¨é•¿è¿æ¥æ¥æ”¶äº‹ä»¶

**é…ç½®æ­¥éª¤**ï¼š

#### æ­¥éª¤ 1ï¼šé€‰æ‹©è®¢é˜…æ–¹å¼
1. ç‚¹å‡»"è®¢é˜…æ–¹å¼"æŒ‰é’®
2. é€‰æ‹©"**ä½¿ç”¨é•¿è¿æ¥æ¥æ”¶äº‹ä»¶**"
3. ç‚¹å‡»"ä¿å­˜"

**è¯´æ˜**ï¼š
- é•¿è¿æ¥æ¨¡å¼æ— éœ€å…¬ç½‘åŸŸåæˆ– Webhook
- éœ€è¦ä½¿ç”¨é£ä¹¦å®˜æ–¹ SDK å¯åŠ¨é•¿è¿æ¥å®¢æˆ·ç«¯
- é€‚åˆæœ¬åœ°å¼€å‘å’Œæµ‹è¯•

#### æ­¥éª¤ 2ï¼šæ·»åŠ äº‹ä»¶
1. ç‚¹å‡»å³ä¸Šè§’"**æ·»åŠ äº‹ä»¶**"æŒ‰é’®
2. åœ¨æœç´¢æ¡†ä¸­è¾“å…¥ï¼š`message` æˆ– `im.message`
3. æ‰¾åˆ°"**im.message.receive_v1**"ï¼ˆæ¥æ”¶æ¶ˆæ¯ï¼‰
4. å‹¾é€‰è¯¥äº‹ä»¶
5. ç‚¹å‡»"ç¡®è®¤æ·»åŠ "
6. ç­‰å¾…é¡µé¢åˆ·æ–°ï¼Œç¡®è®¤äº‹ä»¶å·²æ·»åŠ 

**äº‹ä»¶è¯¦æƒ…**ï¼š
- **äº‹ä»¶åç§°**ï¼šim.message.receive_v1
- **äº‹ä»¶ç±»å‹**ï¼šæ¶ˆæ¯
- **è®¢é˜…ç±»å‹**ï¼šåº”ç”¨èº«ä»½è®¢é˜…
- **æ‰€éœ€æƒé™**ï¼š`im:message`ï¼ˆå·²åœ¨æ­¥éª¤2ä¸­é…ç½®ï¼‰
- **ç”¨é€”**ï¼šæ¥æ”¶ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼ˆå•èŠå’Œç¾¤èŠï¼‰

#### æ­¥éª¤ 3ï¼šéªŒè¯é…ç½®
ç¡®è®¤é¡µé¢æ˜¾ç¤ºï¼š
- âœ… è®¢é˜…æ–¹å¼ï¼šé•¿è¿æ¥
- âœ… å·²æ·»åŠ äº‹ä»¶ï¼šim.message.receive_v1
- âœ… ä¸å†æ˜¾ç¤º"æš‚æ— æ•°æ®"

### 4. å¯åŠ¨æœºå™¨äºº

**å‰ææ¡ä»¶**ï¼š
- âœ… å·²å®Œæˆåº”ç”¨é…ç½®
- âœ… å·²é…ç½®æƒé™
- âœ… å·²é…ç½®äº‹ä»¶è®¢é˜…
- âœ… é£ä¹¦æœºå™¨äººå·²åœ¨æµ‹è¯•ç¾¤ä¸­

**å¯åŠ¨å‘½ä»¤**ï¼š
```bash
cd /path/to/feishu-bot
go run cmd/bot/main.go > /tmp/feishu-bot.log 2>&1 &
```

**éªŒè¯è¿æ¥**ï¼š
```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f /tmp/feishu-bot.log

# åº”è¯¥çœ‹åˆ°
[Info] connected to wss://msg-frontier.feishu.cn/ws/v2
```

### 5. æµ‹è¯•æœºå™¨äºº

**åœ¨æµ‹è¯•ç¾¤ä¸­æµ‹è¯•**ï¼š
```
@æœºå™¨äºº ä½ å¥½
```

**é¢„æœŸç»“æœ**ï¼š
1. ç¾¤èŠä¸­åˆ›å»ºæ–°çš„å¡ç‰‡
2. å¡ç‰‡æ˜¾ç¤º"æ€è€ƒä¸­..."
3. å¡ç‰‡å†…å®¹æµå¼æ›´æ–°ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
4. æœºå™¨äººæ—¥å¿—æ˜¾ç¤ºæ”¶åˆ°æ¶ˆæ¯

**æŸ¥çœ‹æ—¥å¿—**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f /tmp/feishu-bot.log

# æŸ¥çœ‹æ¶ˆæ¯æ¥æ”¶
grep "Message received" /tmp/feishu-bot.log

# æŸ¥çœ‹æµå¼å¯¹è¯
grep "streaming chat" /tmp/feishu-bot.log
```

## ğŸ”§ ç¯å¢ƒé…ç½®

### .env æ–‡ä»¶

```bash
# é£ä¹¦åº”ç”¨é…ç½®
FEISHU_APP_ID=cli_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
FEISHU_APP_SECRET=your_app_secret_here

# æœºå™¨äººé…ç½®ï¼ˆå¯é€‰ï¼‰
BOT_NAME=Claude Stream Bot
LOG_LEVEL=info

# ç¾¤èŠæ˜¯å¦å¿…é¡»@æœºå™¨äººï¼ˆé»˜è®¤ falseï¼‰
GROUP_REQUIRE_MENTION=false
```

### åº”ç”¨é…ç½®æ–‡ä»¶

**configs/config.yaml**ï¼š
```yaml
app:
  id: "cli_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  name: "Claude Stream Bot"
  verification_token: ""

server:
  port: 8080

feishu:
  base_url: "https://open.feishu.cn"
```

## ğŸ“Š é…ç½®æ£€æŸ¥æ¸…å•

éƒ¨ç½²æ–°é¡¹ç›®æ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

- [ ] **1. åº”ç”¨åˆ›å»º**
  - [ ] å·²åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨
  - [ ] å·²è®°å½• App ID å’Œ App Secret

- [ ] **2. æƒé™é…ç½®**
  - [ ] `im:message` âœ…
  - [ ] `im:message.group_at_msg` âœ…
  - [ ] `im:chat` âœ…
  - [ ] `cardkit:card:write` âœ…
  - [ ] å·²å‘å¸ƒç‰ˆæœ¬ï¼ˆæƒé™ç”Ÿæ•ˆï¼‰

- [ ] **3. äº‹ä»¶è®¢é˜…**
  - [ ] è®¢é˜…æ–¹å¼ï¼šé•¿è¿æ¥ âœ…
  - [ ] å·²æ·»åŠ ï¼šim.message.receive_v1 âœ…
  - [ ] é…ç½®å·²ä¿å­˜ âœ…

- [ ] **4. ä»£ç é…ç½®**
  - [ ] .env æ–‡ä»¶å·²é…ç½®
  - [ ] App ID å’Œ Secret æ­£ç¡®
  - [ ] WebSocket è¿æ¥æ­£å¸¸

- [ ] **5. æµ‹è¯•éªŒè¯**
  - [ ] æœºå™¨äººå·²åŠ å…¥æµ‹è¯•ç¾¤
  - [ ] æ—¥å¿—æ˜¾ç¤º WebSocket å·²è¿æ¥
  - [ ] èƒ½æ¥æ”¶å¹¶å“åº” @æœºå™¨äºº æ¶ˆæ¯

## ğŸ› å¸¸è§é—®é¢˜

### 1. å¹³å°æ˜¾ç¤º"åº”ç”¨æœªå»ºç«‹é•¿è¿æ¥"

**ç—‡çŠ¶**ï¼š
- æœºå™¨äººæ—¥å¿—æ˜¾ç¤º `connected`
- ä½†é£ä¹¦å¹³å°æ˜¾ç¤º"åº”ç”¨æœªå»ºç«‹é•¿è¿æ¥"
- æ— æ³•ä¿å­˜äº‹ä»¶è®¢é˜…é…ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤æœºå™¨äººè¿›ç¨‹æ­£åœ¨è¿è¡Œ
2. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æ˜¾ç¤º `connected to wss://msg-frontier.feishu.cn`
3. ç­‰å¾… 2-3 åˆ†é’Ÿï¼Œåˆ·æ–°é¡µé¢é‡è¯•
4. æˆ–ç›´æ¥ç»§ç»­é…ç½®äº‹ä»¶è®¢é˜…ï¼Œå¯èƒ½æ˜¯å¹³å°æ£€æµ‹å»¶è¿Ÿ

### 2. æœºå™¨äººæ”¶ä¸åˆ°æ¶ˆæ¯

**æ£€æŸ¥æ¸…å•**ï¼š
1. [ ] äº‹ä»¶æ˜¯å¦æ·»åŠ ï¼šim.message.receive_v1
2. [ ] æƒé™æ˜¯å¦å¼€å¯ï¼šim:message
3. [ ] æœºå™¨äººæ˜¯å¦åœ¨ç¾¤é‡Œ
4. [ ] æ˜¯å¦ @ äº†æœºå™¨äººï¼ˆç¾¤èŠå¿…éœ€ï¼‰
5. [ ] æŸ¥çœ‹æœºå™¨äººæ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

**è°ƒè¯•å‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥æœºå™¨äººè¿›ç¨‹
ps aux | grep "bot/main"

# æŸ¥çœ‹æ—¥å¿—
tail -50 /tmp/feishu-bot.log

# æœç´¢é”™è¯¯
grep -i "error" /tmp/feishu-bot.log
```

### 3. CardKit æ›´æ–°å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- è¶…è¿‡ 10 QPS é™æµ
- token è¿‡æœŸ
- card_id æˆ– element_id é”™è¯¯
- æƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
- éªŒè¯ `cardkit:card:write` æƒé™
- ç¡®ä¿ä»£ç ä¸­æœ‰é€‚å½“çš„é™æµï¼ˆ100ms é—´éš”ï¼‰

### 4. ç‰ˆæœ¬å‘å¸ƒåæ‰èƒ½ç”Ÿæ•ˆ

**é‡è¦**ï¼šä»¥ä¸‹é…ç½®ä¿®æ”¹éœ€è¦å‘å¸ƒç‰ˆæœ¬æ‰èƒ½ç”Ÿæ•ˆï¼š
- æƒé™çš„æ·»åŠ /ä¿®æ”¹
- åº”ç”¨èƒ½åŠ›å˜æ›´
- æŸäº›å®‰å…¨è®¾ç½®

**å‘å¸ƒç‰ˆæœ¬æ­¥éª¤**ï¼š
1. ç‚¹å‡»"åˆ›å»ºç‰ˆæœ¬"
2. å¡«å†™ç‰ˆæœ¬å·å’Œè¯´æ˜
3. æäº¤å®¡æ ¸ï¼ˆå†…éƒ¨åº”ç”¨è‡ªåŠ¨é€šè¿‡ï¼‰
4. ç­‰å¾…ç‰ˆæœ¬ç”Ÿæ•ˆ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é£ä¹¦å¼€æ”¾å¹³å°æ–‡æ¡£](https://open.feishu.cn/document)
- [CardKit 2.0 æŒ‡å—](https://open.feishu.cn/document/common-capabilities/message-card/card-components)
- [äº‹ä»¶è®¢é˜…æŒ‡å—](https://open.feishu.cn/document/server-docs/event-subscription-guide)
- [é£ä¹¦ Go SDK](https://github.com/larksuite/oapi-sdk-go)

## ğŸ”„ é…ç½®æ¨¡æ¿

### å¿«é€Ÿå¤åˆ¶é…ç½®

**åº”ç”¨ä¿¡æ¯**ï¼š
```yaml
åº”ç”¨ç±»å‹: ä¼ä¸šè‡ªå»ºåº”ç”¨
App ID: cli_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
App Secret: [ä»é£ä¹¦å¹³å°è·å–]
```

**å¿…éœ€æƒé™**ï¼š
```yaml
permissions:
  - im:message
  - im:message.group_at_msg
  - im:chat
  - cardkit:card:write
```

**äº‹ä»¶è®¢é˜…**ï¼š
```yaml
subscription_mode: é•¿è¿æ¥
events:
  - im.message.receive_v1
```

---

**æœ€åæ›´æ–°**ï¼š2026-01-02
**ç»´æŠ¤è€…**ï¼šClaude Code
**é€‚ç”¨äº**ï¼šé£ä¹¦å¼€æ”¾å¹³å°ä¼ä¸šè‡ªå»ºåº”ç”¨
